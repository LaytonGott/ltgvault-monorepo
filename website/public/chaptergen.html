<!DOCTYPE html>
<html lang="en">
<head>
    <script>if(localStorage.getItem('ltgv_is_admin')==='true'){window.va=function(){};window.vaq=[];}</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChapterGen | LTG Vault</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="64x64" href="favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cream: #FAF9F6;
            --emerald: #059669;
            --emerald-dark: #047857;
            --gold: #C9A227;
            --gold-light: #D4AF37;
            --text: #111827;
            --text-secondary: #6B7280;
            --border: #D4CFC7;
            --white: #FFFFFF;
            --success: #059669;
            --error: #DC2626;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        ::selection {
            background: var(--emerald);
            color: var(--white);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--cream);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* ============ HEADER ============ */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            height: 76px;
            background: var(--cream);
            border-bottom: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        header.scrolled {
            background: var(--cream);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
        }

        .header-inner {
            max-width: 1100px;
            height: 100%;
            margin: 0 auto;
            padding: 0 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .logo-img {
            height: 236px;
            width: auto;
            display: block;
            margin-top: 15px;
        }

        nav {
            display: flex;
            align-items: center;
            gap: 36px;
        }

        nav a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 1.1rem;
            font-weight: 500;
            transition: color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        nav a:hover {
            color: var(--text);
        }

        nav a.active {
            color: var(--emerald);
            font-weight: 600;
        }

        /* Main Container */
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 60px 40px;
            padding-top: 100px;
        }

        /* Header Responsive */
        @media (max-width: 1024px) {
            .header-inner {
                padding: 0 24px;
            }
            nav {
                gap: 24px;
            }
            nav a {
                font-size: 1rem;
            }
            .logo-img {
                height: 70px;
            }
            .container {
                padding: 0 24px;
                padding-top: 100px;
            }
        }

        @media (max-width: 768px) {
            header {
                height: auto;
                padding: 12px 0;
            }
            .header-inner {
                flex-direction: column;
                gap: 12px;
            }
            .logo-img {
                height: 180px;
            }
            nav {
                width: 100%;
                justify-content: center;
                gap: 20px;
                flex-wrap: wrap;
            }
            nav a {
                font-size: 0.9rem;
            }
            .container {
                padding-top: 20px;
            }
        }

        @media (max-width: 480px) {
            .logo-img {
                height: 150px;
            }
            nav {
                gap: 16px;
            }
            nav a {
                font-size: 0.85rem;
            }
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text);
        }

        .page-title svg {
            color: var(--emerald);
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 32px;
        }

        /* Cards */
        .card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Status Messages */
        .status {
            padding: 14px 18px;
            border-radius: 10px;
            font-size: 0.9rem;
            margin-bottom: 16px;
            display: none;
            line-height: 1.5;
        }

        .status.visible {
            display: block;
        }

        .status.error {
            background: rgba(220, 38, 38, 0.06);
            border: 1px solid rgba(220, 38, 38, 0.2);
            color: var(--error);
        }

        .status.error a {
            color: var(--emerald);
            text-decoration: underline;
            font-weight: 600;
        }

        .status.error a:hover {
            color: var(--emerald-dark);
        }

        .status.success {
            background: rgba(5, 150, 105, 0.06);
            border: 1px solid rgba(5, 150, 105, 0.2);
            color: var(--success);
        }

        .status.info {
            background: rgba(5, 150, 105, 0.06);
            border: 1px solid rgba(5, 150, 105, 0.15);
            color: var(--emerald);
        }

        .status a {
            color: var(--emerald);
            text-decoration: underline;
        }

        .status a:hover {
            color: var(--emerald-dark);
        }

        /* Input Groups */
        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: border-color 0.2s ease;
        }

        .input-wrapper:focus-within {
            border-color: var(--emerald);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.08);
        }

        .input-wrapper input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text);
            font-size: 0.9rem;
            padding: 14px 16px;
            outline: none;
            font-family: inherit;
        }

        .input-wrapper input::placeholder {
            color: #999;
        }

        /* Instructions */
        .instructions {
            background: rgba(5, 150, 105, 0.04);
            border: 1px solid rgba(5, 150, 105, 0.12);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .instructions-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--emerald);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .instructions ol {
            margin: 0;
            padding-left: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.8;
        }

        .instructions li {
            margin-bottom: 4px;
        }

        .instructions code {
            background: rgba(5, 150, 105, 0.08);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
        }

        textarea {
            width: 100%;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.85rem;
            font-family: 'Monaco', 'Consolas', monospace;
            padding: 14px 16px;
            resize: vertical;
            min-height: 200px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            line-height: 1.6;
        }

        textarea:focus {
            border-color: var(--emerald);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.08);
        }

        /* Output fade-in animation */
        textarea.fade-in {
            animation: fadeInContent 0.25s ease-out;
        }

        @keyframes fadeInContent {
            from { opacity: 0.5; }
            to { opacity: 1; }
        }

        textarea::placeholder {
            color: #999;
            font-family: 'Inter', sans-serif;
        }

        /* Character Counter */
        .char-counter {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            font-size: 0.75rem;
            color: #999;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .char-counter.warning {
            color: #D97706;
        }

        .char-counter.error {
            color: var(--error);
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.primary {
            background: var(--emerald);
            color: var(--white);
            width: 100%;
        }

        .btn.primary:hover:not(:disabled) {
            background: var(--emerald-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
        }

        .btn.primary:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(5, 150, 105, 0.15);
        }

        .btn.primary .btn-text {
            display: inline;
        }

        .btn.primary .btn-loading-text {
            display: none;
        }

        .btn.primary.loading .btn-text {
            display: none;
        }

        .btn.primary.loading .btn-loading-text {
            display: inline;
        }

        .btn.secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn.secondary:hover:not(:disabled) {
            border-color: var(--emerald);
            color: var(--emerald);
            background: rgba(5, 150, 105, 0.04);
        }

        .btn.secondary.copied {
            background: rgba(5, 150, 105, 0.06);
            border-color: var(--success);
            color: var(--success);
        }

        .btn.secondary .copy-icon {
            transition: opacity 0.15s ease;
        }

        .btn.secondary.copied .copy-icon {
            display: none;
        }

        .btn.secondary .check-icon {
            display: none;
        }

        .btn.secondary.copied .check-icon {
            display: inline;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            background: rgba(0, 0, 0, 0.04);
            color: var(--text);
        }

        /* Free Trial Counter */
        .usage-counter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 0.9rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .usage-counter svg {
            color: var(--emerald);
            flex-shrink: 0;
        }

        .usage-counter .count {
            font-weight: 600;
            color: var(--emerald);
        }

        .usage-counter .label {
            color: var(--text-secondary);
        }

        .usage-counter a {
            color: var(--emerald);
            text-decoration: none;
            font-weight: 500;
        }

        .usage-counter a:hover {
            text-decoration: underline;
        }

        .usage-counter.exhausted {
            border-color: rgba(220, 38, 38, 0.2);
            background: rgba(220, 38, 38, 0.03);
        }

        .usage-counter.exhausted .count {
            color: var(--error);
        }

        .usage-counter.exhausted svg {
            color: var(--error);
        }

        .usage-counter.unlimited {
            border-color: rgba(5, 150, 105, 0.2);
            background: rgba(5, 150, 105, 0.04);
        }

        .usage-counter.unlimited .count {
            color: var(--success);
        }

        .usage-counter.unlimited svg {
            color: var(--success);
        }

        .usage-counter.hidden {
            display: none;
        }

        /* Settings Panel */
        .settings-panel {
            display: none;
        }

        .settings-panel.visible {
            display: block;
        }

        .settings-content {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .settings-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
        }

        .hint {
            font-size: 0.75rem;
            color: #999;
            margin-top: 12px;
        }

        .hint a {
            color: var(--emerald);
            text-decoration: none;
        }

        .hint a:hover {
            text-decoration: underline;
        }

        /* Loading */
        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            gap: 16px;
        }

        .loading.visible {
            display: flex;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--emerald);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Results */
        .results {
            display: none;
            margin-top: 24px;
        }

        .results.visible {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .results-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
        }

        .chapters-output {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.8;
            color: var(--text);
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 350px;
            overflow-y: auto;
        }

        .chapters-output::-webkit-scrollbar {
            width: 6px;
        }

        .chapters-output::-webkit-scrollbar-track {
            background: var(--cream);
        }

        .chapters-output::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        /* Footer */
        footer {
            padding: 24px 0;
            border-top: 1px solid var(--border);
            margin-top: 40px;
            background: var(--cream);
        }

        .footer-inner {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 40px;
            text-align: center;
        }

        .footer-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* ============ BEFORE/AFTER SECTION ============ */
        .before-after {
            margin-bottom: 32px;
        }

        .before-after-title {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-align: center;
            margin-bottom: 16px;
        }

        .before-after-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 0;
            align-items: stretch;
        }

        .before-box, .after-box {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .before-box {
            border-right: none;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .after-box {
            border-left: none;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border-color: rgba(5, 150, 105, 0.25);
            background: rgba(5, 150, 105, 0.03);
        }

        .box-label {
            font-size: 0.6rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 10px;
        }

        .after-box .box-label {
            color: var(--emerald);
        }

        .box-content {
            font-size: 0.8rem;
            line-height: 1.5;
            color: var(--text-secondary);
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .after-box .box-content {
            color: var(--text);
        }

        .box-content .chapter-time {
            color: var(--emerald);
            font-weight: 600;
        }

        .before-after-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            color: var(--emerald);
            font-size: 1.2rem;
            background: transparent;
        }

        @media (max-width: 600px) {
            .before-after-grid {
                grid-template-columns: 1fr;
                gap: 0;
            }
            .before-box {
                border-radius: 12px 12px 0 0;
                border-right: 1px solid var(--border);
                border-bottom: none;
            }
            .after-box {
                border-radius: 0 0 12px 12px;
                border-left: 1px solid rgba(5, 150, 105, 0.25);
                border-top: none;
            }
            .before-after-arrow {
                padding: 8px 0;
                background: transparent;
            }
        }

        /* ============ ANIMATED DEMO SECTION ============ */
        .demo-section {
            max-width: 700px;
            margin: 0 auto 40px auto;
            padding: 24px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .demo-title {
            font-size: 0.85rem;
            color: var(--emerald);
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .demo-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .demo-box {
            background: var(--cream);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 16px;
            min-height: 80px;
        }

        .demo-box-label {
            font-size: 0.65rem;
            color: var(--emerald);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .demo-box-content {
            font-size: 0.8rem;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .demo-box-content .cursor {
            display: inline-block;
            width: 2px;
            height: 12px;
            background: var(--emerald);
            margin-left: 1px;
            animation: blink 0.8s infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .demo-box.output .demo-box-content {
            color: var(--text);
        }

        .demo-arrow {
            text-align: center;
            color: var(--emerald);
            font-size: 1.2rem;
        }

        .demo-generate-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            margin: 8px auto 0 auto;
            background: var(--emerald);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: default;
            transition: all 0.2s ease;
            opacity: 0.6;
        }

        .demo-generate-btn.ready {
            opacity: 1;
        }

        .demo-generate-btn.active {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
        }

        .demo-generate-btn.clicked {
            transform: scale(0.98);
            box-shadow: none;
        }

        .demo-generate-btn .demo-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid transparent;
            border-top-color: var(--white);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }

        .demo-generate-btn.loading .demo-spinner {
            display: block;
        }

        .demo-generate-btn.loading .demo-btn-text {
            display: none;
        }

        @media (max-width: 600px) {
            .demo-tool-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============ TWO-COLUMN TOOL LAYOUT ============ */
        .tool-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .tool-panel {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .panel-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .char-count {
            font-size: 0.75rem;
            color: #999;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .char-count.warning { color: #D97706; }
        .char-count.error { color: var(--error); }

        .text-area {
            width: 100%;
            min-height: 300px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            color: var(--text);
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.7;
            resize: vertical;
        }

        .text-area:focus {
            outline: none;
            border-color: var(--emerald);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.08);
        }

        .text-area::placeholder {
            color: #999;
            font-family: 'Inter', sans-serif;
        }

        .text-area[readonly] {
            background: var(--cream);
            cursor: default;
        }

        /* ============ EXTENSION HINT ============ */
        .extension-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 10px;
            margin-bottom: 0;
        }

        .extension-link {
            color: var(--emerald);
            text-decoration: none;
        }

        .extension-link:hover {
            text-decoration: underline;
        }

        /* ============ TRANSCRIPT HELP SECTION ============ */
        .transcript-help {
            margin-top: 12px;
        }

        .transcript-help summary {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px 0;
            list-style: none;
            transition: color 0.2s ease;
        }

        .transcript-help summary::-webkit-details-marker {
            display: none;
        }

        .transcript-help summary:hover {
            color: var(--emerald);
        }

        .transcript-help[open] summary {
            color: var(--emerald);
            margin-bottom: 12px;
        }

        .help-content {
            background: rgba(5, 150, 105, 0.04);
            border: 1px solid rgba(5, 150, 105, 0.12);
            border-radius: 8px;
            padding: 16px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .help-content p {
            margin: 0 0 8px 0;
        }

        .help-content p:last-child {
            margin-top: 12px;
            margin-bottom: 0;
        }

        .help-content ol {
            margin: 0;
            padding-left: 20px;
        }

        .help-content li {
            margin-bottom: 4px;
        }

        .hidden {
            display: none !important;
        }

        .button-row {
            margin-top: 16px;
        }

        .generate-btn {
            width: 100%;
            padding: 16px 24px;
            background: var(--emerald);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .generate-btn:hover:not(:disabled) {
            background: var(--emerald-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
        }

        .generate-btn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(5, 150, 105, 0.15);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .generate-btn .spinner {
            display: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--white);
        }

        .generate-btn .btn-loading-text { display: none; }
        .generate-btn.loading .btn-text { display: none; }
        .generate-btn.loading .btn-loading-text { display: inline; }
        .generate-btn.loading .spinner { display: block; }

        .copy-btn {
            width: 100%;
            padding: 14px 20px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .copy-btn:hover:not(:disabled) {
            border-color: var(--emerald);
            color: var(--emerald);
            background: rgba(5, 150, 105, 0.04);
        }

        .copy-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .copy-btn.copied {
            background: rgba(5, 150, 105, 0.06);
            border-color: var(--success);
            color: var(--success);
        }

        .copy-btn .copy-icon {
            transition: opacity 0.15s ease;
        }

        .copy-btn.copied .copy-icon {
            display: none;
        }

        .copy-btn .check-icon {
            display: none;
        }

        .copy-btn.copied .check-icon {
            display: inline;
        }

        /* Text area for output */
        .text-area {
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .text-area.fade-in {
            animation: fadeInContent 0.25s ease-out;
        }

        .error-message {
            margin-top: 12px;
            padding: 14px 18px;
            background: rgba(220, 38, 38, 0.06);
            border: 1px solid rgba(220, 38, 38, 0.2);
            border-radius: 10px;
            color: var(--error);
            font-size: 0.9rem;
            display: none;
            line-height: 1.5;
        }

        .error-message.visible { display: block; }

        .error-message a {
            color: var(--emerald);
            text-decoration: underline;
            font-weight: 600;
        }

        .error-message a:hover {
            color: var(--emerald-dark);
        }

        /* ============ TOOLTIP GUIDE ============ */
        .tooltip-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9998;
        }

        .tooltip-overlay.visible {
            display: block;
        }

        .tooltip-highlight {
            position: relative;
            z-index: 9999;
            box-shadow: 0 0 0 4px var(--emerald), 0 0 12px rgba(5, 150, 105, 0.25);
            border-radius: 12px;
        }

        .tooltip-box {
            display: none;
            position: fixed;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            max-width: 280px;
            z-index: 10000;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .tooltip-box.visible {
            display: block;
        }

        .tooltip-box::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--white);
            border: 1px solid var(--border);
            border-right: none;
            border-bottom: none;
            transform: rotate(45deg);
        }

        .tooltip-box.arrow-top::before {
            top: -7px;
            left: 24px;
        }

        .tooltip-box.arrow-bottom::before {
            bottom: -7px;
            left: 24px;
            transform: rotate(225deg);
        }

        .tooltip-box.arrow-left::before {
            left: -7px;
            top: 20px;
            transform: rotate(-45deg);
        }

        .tooltip-step {
            font-size: 0.7rem;
            color: var(--emerald);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
        }

        .tooltip-text {
            font-size: 0.9rem;
            color: var(--text);
            line-height: 1.5;
            margin-bottom: 14px;
        }

        .tooltip-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .tooltip-btn {
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .tooltip-btn-primary {
            background: var(--emerald);
            color: var(--white);
        }

        .tooltip-btn-primary:hover {
            background: var(--emerald-dark);
        }

        .tooltip-btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .tooltip-btn-secondary:hover {
            color: var(--text);
            border-color: #ccc;
        }

        /* Output Type Selector */
        .output-type-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .output-type-selector .type-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--emerald);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .output-type-selector .type-label svg {
            color: var(--emerald);
        }

        .output-type-selector .type-select {
            width: 100%;
            padding: 12px 16px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23064E3B' stroke-width='2' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }

        .output-type-selector .type-select:hover {
            border-color: var(--emerald);
        }

        .output-type-selector .type-select:focus {
            outline: none;
            border-color: var(--emerald);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.08);
        }

        .output-type-selector .type-select option {
            background: var(--white);
            color: var(--text);
            padding: 8px;
        }

        /* Quick Actions */
        .quick-actions {
            display: none;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .quick-actions.visible { display: flex; }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .quick-action-btn:hover {
            border-color: var(--emerald);
            color: var(--emerald);
            background: rgba(5, 150, 105, 0.04);
        }

        .quick-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Variation Selector */
        .variation-selector {
            display: none;
            padding: 20px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .variation-selector.visible { display: block; }

        .variation-selector-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        .variation-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .variation-tab {
            padding: 10px 16px;
            background: var(--cream);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .variation-tab:hover {
            border-color: var(--emerald);
            color: var(--text);
        }

        .variation-tab.active {
            background: rgba(5, 150, 105, 0.08);
            border-color: var(--emerald);
            color: var(--emerald);
        }

        /* Alternatives Section */
        .alternatives-section {
            display: none;
            padding: 20px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .alternatives-section.visible { display: block; }

        .alternatives-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        .alternative-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--cream);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .alternative-item:hover {
            border-color: var(--emerald);
        }

        .alternative-item:last-child { margin-bottom: 0; }

        .alternative-text {
            font-size: 0.85rem;
            color: var(--text);
        }

        .alternative-timestamp {
            font-size: 0.75rem;
            color: var(--emerald);
            font-weight: 600;
            margin-right: 8px;
        }

        .use-this-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--emerald);
            border-radius: 6px;
            color: var(--emerald);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .use-this-btn:hover {
            background: var(--emerald);
            color: var(--white);
        }

        /* Improvement Tips */
        .improvement-tips {
            display: none;
            padding: 20px;
            background: rgba(5, 150, 105, 0.03);
            border: 1px solid rgba(5, 150, 105, 0.12);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .improvement-tips.visible { display: block; }

        .improvement-tips-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .improvement-tips-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--success);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tips-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tip-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .tip-bullet {
            color: var(--success);
            font-weight: 600;
        }

        /* Confidence Score */
        .confidence-score {
            display: none;
            text-align: right;
            margin-bottom: 16px;
        }

        .confidence-score.visible { display: block; }

        .confidence-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-right: 8px;
        }

        .confidence-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .confidence-value.high { color: var(--success); }
        .confidence-value.medium { color: #D97706; }
        .confidence-value.low { color: var(--error); }

        /* ============ RESPONSIVE ============ */
        @media (max-width: 768px) {
            .tool-grid {
                grid-template-columns: 1fr;
            }
            .tool-panel {
                padding: 20px;
            }
            .text-area {
                min-height: 200px;
            }
            header {
                padding: 16px 0;
            }
            .header-inner {
                padding: 0 16px;
            }
            .logo-img {
                height: 140px;
            }
            nav {
                display: none;
            }
            .hamburger {
                display: flex;
            }
            .mobile-nav {
                display: flex;
            }
            .container {
                padding: 24px 16px 60px;
            }
            .page-title {
                font-size: 1.5rem;
                gap: 10px;
            }
            .page-title svg {
                width: 24px;
                height: 24px;
            }
            .page-subtitle {
                font-size: 0.9rem;
                margin-bottom: 24px;
            }
            .card {
                padding: 16px;
            }
            .instructions {
                padding: 14px;
            }
            .instructions ol {
                font-size: 0.8rem;
            }
            textarea {
                min-height: 160px;
                font-size: 0.8rem;
            }
            .btn {
                padding: 12px 16px;
                font-size: 0.85rem;
            }
            .results-title {
                font-size: 0.85rem;
            }
            .chapters-output {
                font-size: 0.8rem;
                max-height: 280px;
            }
        }

        @media (max-width: 480px) {
            .logo-img {
                height: 120px;
            }
            .page-title {
                font-size: 1.3rem;
            }
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .instructions-title {
                font-size: 0.8rem;
            }
            .instructions ol {
                font-size: 0.75rem;
                padding-left: 16px;
            }
            .btn.secondary {
                padding: 10px 14px;
                font-size: 0.8rem;
            }
        }

        /* Feedback Section */
        .feedback-section {
            max-width: 1000px;
            margin: 0 auto;
            padding: 60px 40px;
            border-top: 1px solid var(--border);
        }

        .feedback-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text);
        }

        .feedback-subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .feedback-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .feedback-textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            resize: vertical;
            transition: border-color 0.2s ease;
        }

        .feedback-textarea:focus {
            outline: none;
            border-color: var(--emerald);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.08);
        }

        .feedback-textarea::placeholder {
            color: #999;
        }

        .feedback-submit {
            align-self: flex-start;
            padding: 12px 28px;
            background: var(--emerald);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .feedback-submit:hover {
            background: var(--emerald-dark);
            transform: translateY(-1px);
        }

        .feedback-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .feedback-success {
            display: none;
            padding: 16px 20px;
            background: rgba(5, 150, 105, 0.06);
            border: 1px solid rgba(5, 150, 105, 0.2);
            border-radius: 10px;
            color: var(--success);
            font-size: 0.95rem;
        }

        .feedback-success.visible {
            display: block;
        }

        .feedback-error {
            display: none;
            padding: 16px 20px;
            background: rgba(220, 38, 38, 0.06);
            border: 1px solid rgba(220, 38, 38, 0.2);
            border-radius: 10px;
            color: var(--error);
            font-size: 0.95rem;
        }

        .feedback-error.visible {
            display: block;
        }

        /* Pricing Banner */
        .pricing-banner {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .pricing-banner-text {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .pricing-banner-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--emerald);
        }

        .pricing-banner-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .pricing-banner-free {
            font-size: 0.85rem;
            color: var(--text-secondary);
            background: var(--cream);
            padding: 6px 12px;
            border-radius: 20px;
        }

        .pricing-banner .btn-subscribe {
            background: var(--emerald);
            color: var(--white);
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .pricing-banner .btn-subscribe:hover {
            background: var(--emerald-dark);
            transform: translateY(-1px);
        }

        @media (max-width: 480px) {
            .pricing-banner {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
            }
            .pricing-banner .btn-subscribe {
                width: 100%;
                text-align: center;
            }
        }

        /* Bottom CTA */
        .bottom-cta {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            margin-top: 40px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .bottom-cta-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text);
        }

        .bottom-cta-subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .bottom-cta .btn-subscribe {
            background: var(--emerald);
            color: var(--white);
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s ease;
        }

        .bottom-cta .btn-subscribe:hover {
            background: var(--emerald-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.15);
        }

        /* Subscribed button state */
        .btn-subscribed {
            background: var(--emerald) !important;
            color: var(--white) !important;
            cursor: default !important;
        }

        .btn-subscribed:hover {
            background: var(--emerald) !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Checkout Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 100%;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: var(--text);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
            color: var(--text);
        }

        .modal-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-price-tag {
            background: rgba(5, 150, 105, 0.04);
            border: 1px solid rgba(5, 150, 105, 0.15);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-price-tag .tool-name {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .modal-price-tag .price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--emerald);
        }

        .modal-input {
            width: 100%;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px 16px;
            color: var(--text);
            font-size: 0.95rem;
            font-family: inherit;
            margin-bottom: 16px;
            transition: border-color 0.2s ease;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--emerald);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.08);
        }

        .modal-input::placeholder {
            color: #999;
        }

        .modal-btn {
            width: 100%;
            background: var(--emerald);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 14px 20px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .modal-btn:hover:not(:disabled) {
            background: var(--emerald-dark);
            transform: translateY(-1px);
        }

        .modal-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .modal-error {
            background: rgba(220, 38, 38, 0.06);
            border: 1px solid rgba(220, 38, 38, 0.2);
            color: var(--error);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 16px;
            display: none;
        }

        .modal-error.visible {
            display: block;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--cream);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <header id="header">
        <div class="header-inner">
            <a href="/" class="logo"><img src="logo.png" alt="LTG Vault" class="logo-img"></a>
            <nav>
                <a href="postup.html">PostUp</a>
                <a href="threadgen.html">ThreadGen</a>
                <a href="chaptergen.html" class="active">ChapterGen</a>
                <a href="/resume">Resume</a>
                <a href="pricing.html">Pricing</a>
                <a href="dashboard.html">Dashboard</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <h1 class="page-title">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <path d="M9 8L9 16L16 12L9 8Z" fill="currentColor" stroke="none"/>
            </svg>
            ChapterGen
        </h1>
        <p class="page-subtitle">Paste your transcript to generate chapters, clips, or highlights.</p>

        <!-- Pricing Banner -->
        <div class="pricing-banner" id="pricingBanner">
            <div class="pricing-banner-text">
                <span class="pricing-banner-price">$7/month</span>
                <span class="pricing-banner-desc">Unlimited chapters</span>
                <span class="pricing-banner-free" id="freeUsesText">1 free use to start</span>
            </div>
            <button class="btn-subscribe" onclick="openCheckoutModal()">Subscribe</button>
        </div>

        <!-- Before/After Section -->
        <div class="before-after">
            <p class="before-after-title">See the difference</p>
            <div class="before-after-grid">
                <div class="before-box">
                    <div class="box-label">Video transcript</div>
                    <div class="box-content">Welcome back everyone to another video! Today we're covering something really important. So the first topic I want to discuss is how to get started with this. Now moving on to the more advanced tips that will help you level up. And finally let's talk about wrapping everything up...</div>
                </div>
                <div class="before-after-arrow"></div>
                <div class="after-box">
                    <div class="box-label">ChapterGen output</div>
                    <div class="box-content"><span class="chapter-time">0:00</span> Introduction<br><span class="chapter-time">0:15</span> Getting Started<br><span class="chapter-time">2:30</span> Advanced Tips<br><span class="chapter-time">5:45</span> Final Thoughts</div>
                </div>
            </div>
        </div>

        <!-- Status -->
        <div id="status" class="status"></div>

        <!-- Settings Panel -->
        <div id="settingsPanel" class="settings-panel">
            <div class="settings-content">
                <h2 class="settings-title">API Settings</h2>
                <div class="input-group">
                    <label>API Key</label>
                    <div class="input-wrapper">
                        <input type="password" id="apiKey" placeholder="ltgv_..." autocomplete="off">
                        <button id="toggleKey" class="icon-btn" title="Toggle visibility">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <button id="saveKey" class="btn primary">Save API Key</button>
                <p class="hint">
                    <a href="/dashboard.html">Get your API key from the dashboard</a><br>
                    Your key is stored locally and never shared.
                </p>
                <div id="usageInfo" style="margin-top: 12px; font-size: 0.85rem; color: #888; display: none;"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent">
            <!-- Tool Grid: Two Columns -->
            <div class="tool-grid">
                <!-- Left Panel: Input -->
                <div class="tool-panel">
                    <!-- Transcript Input -->
                    <div class="panel-header">
                        <span class="panel-label">Transcript</span>
                        <span class="char-count" id="inputCount">0 / 50,000</span>
                    </div>
                    <textarea class="text-area" id="transcriptArea" placeholder="Paste your video transcript here..."></textarea>

                    <!-- Extension Link -->
                    <p class="extension-hint">
                        Paste transcript below -or <a href="/chaptergen-extension/" target="_blank" class="extension-link">get the Chrome extension</a> to auto-grab from YouTube
                    </p>

                    <!-- Collapsible Help Section -->
                    <details class="transcript-help">
                        <summary class="help-toggle">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            How to get your transcript
                        </summary>
                        <div class="help-content">
                            <p><strong>YouTube:</strong></p>
                            <ol>
                                <li>Open your video on YouTube</li>
                                <li>Click "...more" below the video</li>
                                <li>Click "Show transcript"</li>
                                <li>Click the three dots  "Toggle timestamps" (optional)</li>
                                <li>Select all text (Ctrl+A)  Copy (Ctrl+C)</li>
                                <li>Paste here</li>
                            </ol>
                            <p><strong>Other platforms:</strong> Most video platforms have a similar transcript option, or you can use a transcription service.</p>
                        </div>
                    </details>

                    <!-- Output Type Selector -->
                    <div class="output-type-selector" style="margin-top: 16px;">
                        <label class="type-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10 9 9 9 8 9"/>
                            </svg>
                            Output Type
                        </label>
                        <select class="type-select" id="outputTypeSelect">
                            <option value="chapters"> Chapters -timestamps + titles</option>
                            <option value="clips"> Clip Suggestions -viral moments for Shorts</option>
                            <option value="blog"> Blog Outline -structured blog post</option>
                            <option value="highlights"> Key Highlights -important bullet points</option>
                        </select>
                    </div>

                    <!-- Usage Counter -->
                    <div id="usageCounter" class="usage-counter" style="margin-top: 16px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                        </svg>
                        <span id="usageText"><span class="count">1</span> <span class="label">free use left</span></span>
                    </div>

                    <div class="button-row">
                        <button class="generate-btn" id="generateBtn">
                            <span class="btn-text">Generate Chapters</span>
                            <span class="btn-loading-text">Generating...</span>
                            <div class="spinner"></div>
                        </button>
                    </div>
                    <div class="error-message" id="errorMessage"></div>
                </div>

                <!-- Right Panel: Output -->
                <div class="tool-panel">
                    <div class="panel-header">
                        <span class="panel-label">Generated Chapters</span>
                        <span class="char-count" id="outputCount">0 chars</span>
                    </div>
                    <textarea class="text-area" id="outputText" placeholder="Your YouTube chapters will appear here..." readonly></textarea>

                    <div class="button-row">
                        <button class="copy-btn" id="copyBtn" disabled>
                            <svg class="copy-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            <svg class="check-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            <span id="copyText">Copy to Clipboard</span>
                        </button>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions" id="quickActions">
                        <button class="quick-action-btn" data-action="more_chapters">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            More Chapters
                        </button>
                        <button class="quick-action-btn" data-action="shorter_titles">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 4H3M21 8H9M21 12H3M21 16H9M21 20H3"/>
                            </svg>
                            Shorter Titles
                        </button>
                        <button class="quick-action-btn" data-action="add_timestamps">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            Add Timestamps
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading (shows during generation) -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p id="loadingText">Analyzing transcript...</p>
            </div>

            <!-- Variation Selector -->
            <div class="variation-selector" id="variationSelector">
                <div class="variation-selector-title">Chapter Styles</div>
                <div class="variation-tabs" id="variationTabs"></div>
            </div>

            <!-- Alternative Titles -->
            <div class="alternatives-section" id="alternativesSection">
                <div class="alternatives-title">Alternative Titles</div>
                <div class="alternatives-list" id="alternativesList"></div>
            </div>

            <!-- Improvement Tips -->
            <div class="improvement-tips" id="improvementTips">
                <div class="improvement-tips-header">
                    <div class="improvement-tips-title">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                        </svg>
                        Improvement Tips
                    </div>
                </div>
                <div class="tips-list" id="tipsList"></div>
            </div>

            <!-- Confidence Score -->
            <div class="confidence-score" id="confidenceScore">
                <span class="confidence-label">Quality Score:</span>
                <span class="confidence-value" id="confidenceValue">--/100</span>
            </div>

            <!-- Settings Button (floating) -->
            <button id="settingsBtn" class="icon-btn" title="API Settings" style="position: fixed; bottom: 20px; right: 20px; background: var(--white); border: 1px solid var(--border); padding: 12px; border-radius: 50%; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
                </svg>
            </button>

            <!-- Bottom CTA -->
            <div class="bottom-cta" id="bottomCta">
                <h3 class="bottom-cta-title">Get unlimited access</h3>
                <p class="bottom-cta-subtitle">Generate unlimited YouTube chapters for just $7/month</p>
                <button class="btn-subscribe" onclick="openCheckoutModal()">Subscribe Now</button>
            </div>
        </div>
    </main>

    <!-- Animated Demo Section -->
    <div class="demo-section">
        <p class="demo-title">Watch it in action</p>
        <div class="demo-container">
            <div class="demo-box input">
                <div class="demo-box-label">Transcript</div>
                <div class="demo-box-content" id="demoInput"></div>
            </div>
            <div class="demo-arrow"></div>
            <button class="demo-generate-btn" id="demoButton">
                <span class="demo-spinner"></span>
                <span class="demo-btn-text">Generate Chapters</span>
            </button>
            <div class="demo-arrow"></div>
            <div class="demo-box output">
                <div class="demo-box-label">Chapters</div>
                <div class="demo-box-content" id="demoOutput"></div>
            </div>
        </div>
    </div>

    <!-- Feedback Section -->
    <section class="feedback-section">
        <h2 class="feedback-title">Help me improve this tool</h2>
        <p class="feedback-subtitle">Got ideas, bugs, or feedback? I'd love to hear from you.</p>
        <form class="feedback-form" id="feedbackForm">
            <input type="hidden" name="tool" value="ChapterGen">
            <textarea class="feedback-textarea" name="message" id="feedbackText" placeholder="What's on your mind?" required></textarea>
            <button type="submit" class="feedback-submit" id="feedbackSubmit">Submit Feedback</button>
        </form>
        <div class="feedback-success" id="feedbackSuccess">Thanks for your feedback! I really appreciate it.</div>
        <div class="feedback-error" id="feedbackError">Something went wrong. Please try again.</div>
    </section>

    <footer>
        <div class="footer-inner">
            <p class="footer-text">Built by LTG</p>
        </div>
    </footer>

    <!-- Checkout Modal -->
    <div class="modal-overlay" id="checkoutModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeCheckoutModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
            <h2 class="modal-title">Subscribe to ChapterGen</h2>
            <p class="modal-subtitle">Unlimited chapters, cancel anytime</p>
            <div class="modal-price-tag">
                <div class="tool-name">ChapterGen</div>
                <div class="price">$7/month</div>
            </div>
            <div class="modal-error" id="checkoutError"></div>
            <input type="email" class="modal-input" id="checkoutEmail" placeholder="Enter your email" autocomplete="email">
            <button class="modal-btn" id="checkoutBtn" onclick="startCheckout()">Continue to Checkout</button>
        </div>
    </div>

    <script>
        // Checkout Modal Functions
        function openCheckoutModal() {
            document.getElementById('checkoutModal').classList.add('visible');
            document.getElementById('checkoutEmail').focus();
        }

        function closeCheckoutModal() {
            document.getElementById('checkoutModal').classList.remove('visible');
            document.getElementById('checkoutError').classList.remove('visible');
            document.getElementById('checkoutEmail').value = '';
        }

        // Close modal on overlay click
        document.getElementById('checkoutModal').addEventListener('click', function(e) {
            if (e.target === this) closeCheckoutModal();
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeCheckoutModal();
        });

        async function startCheckout() {
            var email = document.getElementById('checkoutEmail').value.trim();
            var errorEl = document.getElementById('checkoutError');
            var btn = document.getElementById('checkoutBtn');

            // Validate email
            if (!email) {
                errorEl.textContent = 'Please enter your email address';
                errorEl.classList.add('visible');
                return;
            }

            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorEl.textContent = 'Please enter a valid email address';
                errorEl.classList.add('visible');
                return;
            }

            errorEl.classList.remove('visible');
            btn.disabled = true;
            btn.textContent = 'Redirecting...';

            try {
                var response = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, tool: 'chaptergen' })
                });

                var data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create checkout session');
                }

                if (data.url) {
                    window.location.href = data.url;
                } else {
                    throw new Error('No checkout URL returned');
                }
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.classList.add('visible');
                btn.disabled = false;
                btn.textContent = 'Continue to Checkout';
            }
        }

        // Handle Enter key in email input
        document.getElementById('checkoutEmail').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') startCheckout();
        });
    </script>

    <script>
        // ============ FREE TRIAL SYSTEM ============
        var FREE_TRIAL_LIMIT = 1;
        var FREE_TRIAL_KEY = 'chaptergen_free_uses';

        function getFreeTrialUses() {
            var uses = localStorage.getItem(FREE_TRIAL_KEY);
            if (uses === null) {
                localStorage.setItem(FREE_TRIAL_KEY, FREE_TRIAL_LIMIT);
                return FREE_TRIAL_LIMIT;
            }
            var parsedUses = parseInt(uses, 10);
            // Cap at limit (in case limit was reduced)
            if (parsedUses > FREE_TRIAL_LIMIT) {
                localStorage.setItem(FREE_TRIAL_KEY, FREE_TRIAL_LIMIT);
                return FREE_TRIAL_LIMIT;
            }
            return parsedUses;
        }

        function decrementFreeTrial() {
            var uses = getFreeTrialUses();
            console.log('=== DECREMENT FREE TRIAL ===');
            console.log('Before decrement:', uses);
            if (uses > 0) {
                localStorage.setItem(FREE_TRIAL_KEY, uses - 1);
                console.log('After decrement:', uses - 1);
                console.log('localStorage now:', localStorage.getItem(FREE_TRIAL_KEY));
            } else {
                console.log('No uses left to decrement');
            }
            return uses - 1;
        }

        // DOM Elements
        var elements = {
            settingsBtn: document.getElementById('settingsBtn'),
            settingsPanel: document.getElementById('settingsPanel'),
            apiKeyInput: document.getElementById('apiKey'),
            toggleKeyBtn: document.getElementById('toggleKey'),
            saveKeyBtn: document.getElementById('saveKey'),
            mainContent: document.getElementById('mainContent'),
            status: document.getElementById('status'),
            transcriptArea: document.getElementById('transcriptArea'),
            generateBtn: document.getElementById('generateBtn'),
            loading: document.getElementById('loading'),
            loadingText: document.getElementById('loadingText'),
            outputText: document.getElementById('outputText'),
            copyBtn: document.getElementById('copyBtn'),
            freeUsesText: document.getElementById('freeUsesText'),
            inputCount: document.getElementById('inputCount'),
            outputCount: document.getElementById('outputCount'),
            quickActions: document.getElementById('quickActions'),
            variationSelector: document.getElementById('variationSelector'),
            variationTabs: document.getElementById('variationTabs'),
            alternativesSection: document.getElementById('alternativesSection'),
            alternativesList: document.getElementById('alternativesList'),
            improvementTips: document.getElementById('improvementTips'),
            tipsList: document.getElementById('tipsList'),
            confidenceScore: document.getElementById('confidenceScore'),
            confidenceValue: document.getElementById('confidenceValue'),
            errorMessage: document.getElementById('errorMessage'),
            outputTypeSelect: document.getElementById('outputTypeSelect'),
            outputPanelLabel: document.querySelector('.tool-panel .panel-label')
        };

        // Output type labels for panel header
        var outputTypeLabels = {
            'chapters': 'Generated Chapters',
            'clips': 'Clip Suggestions',
            'blog': 'Blog Outline',
            'highlights': 'Key Highlights'
        };

        // Button text based on output type
        var outputTypeButtonText = {
            'chapters': 'Generate Chapters',
            'clips': 'Generate Clips',
            'blog': 'Generate Outline',
            'highlights': 'Generate Highlights'
        };

        // State
        var generatedChapters = '';
        var currentVariations = [];
        var currentVariationIndex = 0;
        var apiKeyValid = false;  // Track if stored API key is valid
        var isSubscribed = false; // Track if subscribed to THIS tool specifically

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadApiKey();
            setupEventListeners();
            updateFreeTrialUI();
            prefillExampleText();
            updateInputCounter();
            startDemoAnimation();
            checkForExtensionData();
        });

        // Check if transcript was sent from Chrome extension
        function checkForExtensionData() {
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('from_extension') !== 'true') return;

            var transcriptReceived = false;

            // Method 1: Check URL parameter (most reliable for short transcripts)
            var urlTranscript = urlParams.get('transcript');
            if (urlTranscript) {
                try {
                    var decoded = decodeURIComponent(urlTranscript);
                    if (decoded && decoded.length > 0) {
                        elements.transcriptArea.value = decoded;
                        updateInputCounter();
                        showStatus('Transcript received from extension!', 'success');
                        transcriptReceived = true;
                        // Switch to manual mode since we have a transcript
                        switchToManualInput();
                    }
                } catch (e) {
                    console.log('Failed to decode URL transcript:', e);
                }
            }

            // Method 2: Check localStorage/sessionStorage (for long transcripts)
            function loadExtensionTranscript() {
                if (transcriptReceived) return true;

                var storedTranscript = localStorage.getItem('chaptergen_extension_transcript') ||
                                       sessionStorage.getItem('chaptergen_extension_transcript');
                if (storedTranscript) {
                    elements.transcriptArea.value = storedTranscript;
                    updateInputCounter();
                    localStorage.removeItem('chaptergen_extension_transcript');
                    sessionStorage.removeItem('chaptergen_extension_transcript');
                    showStatus('Transcript received from extension!', 'success');
                    transcriptReceived = true;
                    // Switch to manual mode since we have a transcript
                    switchToManualInput();
                    return true;
                }
                return false;
            }

            // Helper to switch to manual input mode
            function switchToManualInput() {
                var manualTab = document.querySelector('[data-input-mode="manual"]');
                if (manualTab) manualTab.click();
            }

            // If not from URL, try storage methods
            if (!transcriptReceived) {
                // Try immediately
                loadExtensionTranscript();

                // Listen for custom event from extension
                window.addEventListener('chaptergen_transcript_ready', function(e) {
                    if (!transcriptReceived) {
                        // Event might have transcript in detail
                        if (e.detail) {
                            elements.transcriptArea.value = e.detail;
                            updateInputCounter();
                            showStatus('Transcript received from extension!', 'success');
                            transcriptReceived = true;
                            switchToManualInput();
                        } else {
                            loadExtensionTranscript();
                        }
                    }
                });

                // Listen for storage events (backup method)
                window.addEventListener('storage', function(e) {
                    if (e.key === 'chaptergen_extension_transcript' && e.newValue && !transcriptReceived) {
                        elements.transcriptArea.value = e.newValue;
                        updateInputCounter();
                        localStorage.removeItem('chaptergen_extension_transcript');
                        showStatus('Transcript received from extension!', 'success');
                        transcriptReceived = true;
                        switchToManualInput();
                    }
                });

                // Poll for a longer time in case of delays
                var attempts = 0;
                var pollInterval = setInterval(function() {
                    if (loadExtensionTranscript() || attempts > 20 || transcriptReceived) {
                        clearInterval(pollInterval);
                    }
                    attempts++;
                }, 300);
            }

            // Clean up URL after a delay (to allow multiple loads)
            setTimeout(function() {
                window.history.replaceState({}, '', window.location.pathname);
            }, 2000);
        }

        // Pre-fill example text for first-time users (disabled for URL flow)
        function prefillExampleText() {
            // No longer pre-fill since we use URL input now
            // Keep function for backward compatibility
        }

        function markAsGenerated() {
            localStorage.setItem('chaptergen_has_generated', 'true');
        }

        // Animated Demo
        function startDemoAnimation() {
            setTimeout(function() {
                var demoInput = document.getElementById('demoInput');
                var demoOutput = document.getElementById('demoOutput');
                var demoButton = document.getElementById('demoButton');

                if (!demoInput || !demoOutput || !demoButton) return;

                var inputText = "Hey everyone welcome back to the channel! So today I want to talk about something really important, productivity hacks that actually work in real life. First thing you need to understand is that most advice out there is complete garbage written by people who have never actually tried it. Now the first real technique I want to share is time blocking, and this completely changed my life when I started doing it consistently. You basically schedule every single hour of your day in advance. The second technique is batching similar tasks together so you're not constantly context switching. And finally let's talk about the Pomodoro technique, where you work in focused 25 minute sprints with 5 minute breaks in between.";
                var outputText = "0:00 Introduction\n0:12 Why Most Productivity Advice Fails\n0:28 Time Blocking Method Explained\n0:52 Task Batching Strategy\n1:08 The Pomodoro Technique";

                function runAnimation() {
                    demoInput.innerHTML = '<span class="cursor"></span>';
                    demoOutput.innerHTML = '';
                    demoButton.classList.remove('ready', 'active', 'clicked', 'loading');

                    var inputIndex = 0;
                    var outputIndex = 0;

                    function typeInput() {
                        if (inputIndex < inputText.length) {
                            demoInput.innerHTML = inputText.substring(0, inputIndex + 1) + '<span class="cursor"></span>';
                            inputIndex++;
                            setTimeout(typeInput, 10);
                        } else {
                            demoInput.innerHTML = inputText;
                            demoButton.classList.add('ready');
                            setTimeout(clickButton, 300);
                        }
                    }

                    function clickButton() {
                        demoButton.classList.add('active');
                        setTimeout(function() {
                            demoButton.classList.add('clicked');
                            setTimeout(function() {
                                demoButton.classList.remove('clicked');
                                demoButton.classList.add('loading');
                                setTimeout(typeOutput, 400);
                            }, 80);
                        }, 150);
                    }

                    function typeOutput() {
                        demoButton.classList.remove('loading');
                        if (outputIndex < outputText.length) {
                            demoOutput.innerHTML = outputText.substring(0, outputIndex + 1).replace(/\n/g, '<br>');
                            outputIndex++;
                            setTimeout(typeOutput, 20);
                        } else {
                            setTimeout(runAnimation, 3000);
                        }
                    }

                    setTimeout(typeInput, 400);
                }

                runAnimation();
            }, 100);
        }

        function setupEventListeners() {
            elements.settingsBtn.addEventListener('click', toggleSettings);
            elements.toggleKeyBtn.addEventListener('click', toggleKeyVisibility);
            elements.saveKeyBtn.addEventListener('click', saveApiKey);
            elements.generateBtn.addEventListener('click', generateChapters);
            elements.copyBtn.addEventListener('click', copyChapters);
            elements.transcriptArea.addEventListener('input', updateInputCounter);
            elements.outputText.addEventListener('input', updateOutputCounter);

            // Quick action buttons
            var quickBtns = document.querySelectorAll('.quick-action-btn');
            quickBtns.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var action = btn.getAttribute('data-action');
                    handleQuickAction(action);
                });
            });

            // Output type selector
            elements.outputTypeSelect.addEventListener('change', function() {
                var outputType = elements.outputTypeSelect.value;
                if (elements.outputPanelLabel) {
                    elements.outputPanelLabel.textContent = outputTypeLabels[outputType] || 'Generated Chapters';
                }
                // Update button text based on output type
                var btnText = elements.generateBtn.querySelector('.btn-text');
                if (btnText) {
                    btnText.textContent = outputTypeButtonText[outputType] || 'Generate Chapters';
                }
                // Show/hide quick actions based on output type (only show for chapters)
                if (outputType !== 'chapters') {
                    elements.quickActions.classList.remove('visible');
                } else if (generatedChapters) {
                    elements.quickActions.classList.add('visible');
                }
            });
        }

        function toggleSettings() {
            elements.settingsPanel.classList.toggle('visible');
        }

        function toggleKeyVisibility() {
            elements.apiKeyInput.type = elements.apiKeyInput.type === 'password' ? 'text' : 'password';
        }

        function isLtgvKey(key) {
            return key && key.indexOf('ltgv_') === 0;
        }

        // Output fade-in animation
        function animateOutput() {
            elements.outputText.classList.remove('fade-in');
            void elements.outputText.offsetWidth; // Trigger reflow
            elements.outputText.classList.add('fade-in');
        }

        function loadApiKey() {
            var ltgvKey = localStorage.getItem('ltgv_api_key');

            if (ltgvKey) {
                elements.apiKeyInput.value = ltgvKey;
                // Check subscription status
                checkSubscriptionStatus(ltgvKey);
            }
            // Free trial users don't need to add an API key
        }

        // Check subscription status and hide Subscribe CTA if subscribed
        function checkSubscriptionStatus(apiKey) {
            console.log('=== SUBSCRIPTION CHECK DEBUG ===');
            fetch('/api/keys', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey
                }
            })
            .then(function(response) {
                // Handle invalid/revoked API keys
                if (response.status === 401) {
                    console.log('API key is invalid or revoked - removing from localStorage');
                    localStorage.removeItem('ltgv_api_key');
                    elements.apiKeyInput.value = '';
                    apiKeyValid = false;
                    updateFreeTrialUI(false);
                    return { success: false, invalid: true };
                }
                return response.json();
            })
            .then(function(data) {
                if (data.invalid) {
                    // Already handled above
                    return;
                }
                console.log('Subscription data:', data.subscriptions);
                if (data.success && data.subscriptions && data.subscriptions.chaptergen) {
                    console.log('User is subscribed to ChapterGen - updating buttons');
                    apiKeyValid = true;
                    isSubscribed = true;
                    // Update usage counter to show unlimited
                    updateFreeTrialUI(true);
                    // Update all subscribe buttons to show subscribed state
                    var subscribeButtons = document.querySelectorAll('.btn-subscribe');
                    subscribeButtons.forEach(function(btn) {
                        btn.textContent = 'Subscribed ';
                        btn.classList.add('btn-subscribed');
                        btn.onclick = function(e) {
                            e.preventDefault();
                            alert('You\'re already subscribed to ChapterGen! Manage your subscription in the dashboard.');
                        };
                    });
                    // Update the bottom CTA text
                    var ctaText = document.querySelector('#bottomCta p');
                    if (ctaText) {
                        ctaText.textContent = 'You have unlimited access to ChapterGen.';
                    }
                } else if (data.success) {
                    // Key is valid but NOT subscribed to ChapterGen
                    console.log('User not subscribed to ChapterGen, but key is valid');
                    apiKeyValid = true;
                    isSubscribed = false;
                    updateFreeTrialUI(false);
                } else {
                    console.log('API key validation failed');
                    apiKeyValid = false;
                    isSubscribed = false;
                    updateFreeTrialUI(false);
                }
            })
            .catch(function(err) {
                console.log('Subscription check ERROR:', err);
                apiKeyValid = false;
                updateFreeTrialUI(false);
            });
        }

        function saveApiKey() {
            var apiKey = elements.apiKeyInput.value.trim();

            if (!apiKey) {
                showStatus('Please enter your API key. <a href="/dashboard.html">Get your key from the dashboard</a>', 'error');
                return;
            }

            if (isLtgvKey(apiKey)) {
                localStorage.setItem('ltgv_api_key', apiKey);
                showStatus('API key saved', 'success');
                // Check subscription status for newly saved key
                checkSubscriptionStatus(apiKey);
                updateFreeTrialUI();
            } else {
                showStatus('Invalid key format. Your key should start with ltgv_. <a href="/dashboard.html">Get a new key</a>', 'error');
                return;
            }

            setTimeout(function() {
                elements.settingsPanel.classList.remove('visible');
                hideStatus();
            }, 1500);
        }

        function showStatus(message, type = 'info') {
            elements.status.innerHTML = message;
            elements.status.className = 'status visible ' + type;
        }

        function hideStatus() {
            elements.status.classList.remove('visible');
        }

        function updateFreeTrialUI(isSubscribed) {
            var ltgvKey = localStorage.getItem('ltgv_api_key');
            var usageCounter = document.getElementById('usageCounter');
            var usageText = document.getElementById('usageText');
            var settingsPanel = document.getElementById('settingsPanel');
            var bottomCta = document.getElementById('bottomCta');

            console.log('=== UPDATE FREE TRIAL UI ===');
            console.log('isSubscribed:', isSubscribed);
            console.log('ltgvKey:', ltgvKey ? 'exists' : 'null');

            // If user is subscribed, show unlimited and hide settings panel + CTA
            if (isSubscribed) {
                if (usageCounter) {
                    usageCounter.className = 'usage-counter unlimited';
                    usageText.innerHTML = '<span class="count">Unlimited</span> <span class="label">uses</span>';
                }
                if (elements.freeUsesText) {
                    elements.freeUsesText.style.display = 'none';
                }
                if (settingsPanel) {
                    settingsPanel.style.display = 'none';
                }
                if (bottomCta) {
                    bottomCta.style.display = 'none';
                }
                elements.generateBtn.disabled = false;
                return;
            }

            // Show settings panel and CTA for non-subscribed users
            if (settingsPanel) {
                settingsPanel.style.display = 'block';
            }
            if (bottomCta) {
                bottomCta.style.display = 'block';
            }

            // If user has API key but not subscribed, hide counter (they use API limits)
            if (ltgvKey) {
                if (usageCounter) {
                    usageCounter.style.display = 'none';
                }
                if (elements.freeUsesText) {
                    elements.freeUsesText.style.display = 'none';
                }
                elements.generateBtn.disabled = false;
                return;
            }

            // Free trial user - show remaining uses from localStorage
            var uses = getFreeTrialUses();
            console.log('Free trial uses from localStorage:', uses);

            if (usageCounter && usageText) {
                usageCounter.style.display = 'flex';
                if (uses > 0) {
                    usageCounter.className = 'usage-counter';
                    usageText.innerHTML = '<span class="count">' + uses + '</span> <span class="label">free ' + (uses === 1 ? 'use' : 'uses') + ' left</span>';
                    elements.generateBtn.disabled = false;
                    console.log('Updated counter to show:', uses, 'uses');
                } else {
                    usageCounter.className = 'usage-counter exhausted';
                    usageText.innerHTML = '<span class="count">0</span> <span class="label">uses left</span>  <a href="/pricing.html">Get unlimited</a>';
                    elements.generateBtn.disabled = true;
                    console.log('Updated counter to show: 0 uses (exhausted)');
                }
            }

            // Update old banner text too
            if (elements.freeUsesText) {
                if (uses > 0) {
                    elements.freeUsesText.textContent = uses + ' free ' + (uses === 1 ? 'use' : 'uses') + ' remaining';
                    elements.freeUsesText.style.display = 'inline-block';
                } else {
                    elements.freeUsesText.textContent = 'Free trial ended';
                    elements.freeUsesText.style.display = 'inline-block';
                }
            }
        }

        // Character counter for transcript input
        function updateInputCounter() {
            var length = elements.transcriptArea.value.length;
            var formatted = length.toLocaleString();
            elements.inputCount.textContent = formatted + ' / 50,000';

            // Update color based on length
            elements.inputCount.classList.remove('warning', 'error');
            if (length >= 50000) {
                elements.inputCount.classList.add('error');
            } else if (length >= 40000) {
                elements.inputCount.classList.add('warning');
            }
        }

        // Character counter for output
        function updateOutputCounter() {
            var length = elements.outputText.value.length;
            elements.outputCount.textContent = length.toLocaleString() + ' chars';
        }

        async function generateChapters() {
            // Check for API key or free trial
            var ltgvKey = localStorage.getItem('ltgv_api_key');
            var freeUses = getFreeTrialUses();
            // Use free trial if: no key OR invalid key OR not subscribed to THIS tool
            var usingFreeTrial = (!ltgvKey || !apiKeyValid || !isSubscribed) && freeUses > 0;

            console.log('=== GENERATE CHAPTERS START ===');
            console.log('ltgvKey:', ltgvKey ? 'exists' : 'null');
            console.log('apiKeyValid:', apiKeyValid);
            console.log('isSubscribed:', isSubscribed);
            console.log('freeUses:', freeUses);
            console.log('usingFreeTrial:', usingFreeTrial);

            // Block if not subscribed AND no free uses left
            if ((!ltgvKey || !apiKeyValid || !isSubscribed) && freeUses <= 0) {
                showStatus('Free trial ended. <a href="/pricing.html">Subscribe for unlimited access</a>', 'error');
                return;
            }

            // Check for transcript
            var transcript = elements.transcriptArea.value.trim();
            if (!transcript) {
                showStatus('Enter a YouTube URL to fetch the transcript, or paste it manually.', 'error');
                return;
            }

            if (transcript.length < 100) {
                showStatus('Transcript is too short (minimum 100 characters). Paste a longer transcript to generate meaningful chapters.', 'error');
                return;
            }

            if (transcript.length > 50000) {
                var charCount = transcript.length.toLocaleString();
                showStatus('Transcript is too long (' + charCount + ' characters). Maximum is 50,000. Try trimming the beginning or end.', 'error');
                return;
            }

            // Get output type for loading message
            var outputType = elements.outputTypeSelect.value;
            var loadingMessages = {
                'chapters': 'Generating chapters...',
                'clips': 'Finding viral moments...',
                'blog': 'Creating blog outline...',
                'highlights': 'Extracting key highlights...'
            };

            // Show loading
            elements.generateBtn.disabled = true;
            elements.generateBtn.classList.add('loading');
            elements.loading.classList.add('visible');
            elements.loadingText.textContent = loadingMessages[outputType] || 'Analyzing transcript...';
            elements.quickActions.classList.remove('visible');
            elements.variationSelector.classList.remove('visible');
            elements.alternativesSection.classList.remove('visible');
            elements.improvementTips.classList.remove('visible');
            elements.confidenceScore.classList.remove('visible');
            hideStatus();

            try {
                var chapters;
                var headers = { 'Content-Type': 'application/json' };

                if (ltgvKey) {
                    headers['x-api-key'] = ltgvKey;
                } else {
                    headers['x-free-trial'] = 'true';
                }

                // Get selected output type
                var outputType = elements.outputTypeSelect.value;

                // Update panel label based on output type
                if (elements.outputPanelLabel) {
                    elements.outputPanelLabel.textContent = outputTypeLabels[outputType] || 'Generated Chapters';
                }

                // Use LTG Vault API
                var response = await fetch('/api/tools/chaptergen', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ transcript: transcript, outputType: outputType })
                });

                var data = await response.json();

                if (!response.ok) {
                    if (data.error === 'LIMIT_EXCEEDED') {
                        throw new Error('Free trial ended. <a href="/pricing.html">Subscribe for unlimited access</a>');
                    }
                    if (data.error && (data.error.includes('Invalid') || data.error.includes('revoked') || data.error.includes('expired'))) {
                        throw new Error('Your access has expired. <a href="/dashboard.html">Get a new access link</a>');
                    }
                    throw new Error('Something went wrong. Please try again.');
                }

                chapters = data.result;
                console.log('=== GENERATION SUCCESS ===');
                console.log('usingFreeTrial:', usingFreeTrial);

                // Handle free trial decrement
                if (usingFreeTrial) {
                    console.log('Calling decrementFreeTrial...');
                    decrementFreeTrial();
                    updateFreeTrialUI();
                } else {
                    console.log('Not using free trial, skipping decrement');
                }

                // Show usage info for authenticated users
                if (data.usage) {
                    var usageInfo = document.getElementById('usageInfo');
                    var limitText = data.usage.limit === 'unlimited' ? 'unlimited' : data.usage.limit;
                    usageInfo.textContent = 'Usage this month: ' + data.usage.used + ' / ' + limitText;
                    usageInfo.style.display = 'block';
                }

                // Display results
                generatedChapters = chapters;
                elements.outputText.value = chapters;
                animateOutput();
                updateOutputCounter();

                // Enable UI elements
                elements.copyBtn.disabled = false;
                elements.quickActions.classList.add('visible');
                markAsGenerated();

                // Auto-copy
                try {
                    await navigator.clipboard.writeText(chapters);
                    showStatus('Chapters generated and copied to clipboard!', 'success');
                    showCopiedFeedback();
                } catch (e) {
                    showStatus('Chapters generated! Click Copy to save.', 'success');
                }

            } catch (error) {
                showStatus(error.message || 'Something went wrong. Please try again.', 'error');
            } finally {
                elements.loading.classList.remove('visible');
                elements.generateBtn.disabled = false;
                elements.generateBtn.classList.remove('loading');
            }
        }

        function showCopiedFeedback() {
            var originalHTML = elements.copyBtn.innerHTML;
            elements.copyBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Copied!';
            elements.copyBtn.classList.add('copied');

            setTimeout(function() {
                elements.copyBtn.innerHTML = originalHTML;
                elements.copyBtn.classList.remove('copied');
            }, 3000);
        }

        async function copyChapters() {
            var text = elements.outputText.value;
            if (!text) return;

            try {
                await navigator.clipboard.writeText(text);
                showCopiedFeedback();
            } catch (e) {
                showStatus('Could not copy to clipboard. Try selecting and copying manually.', 'error');
            }
        }

        // Quick action handler
        async function handleQuickAction(action) {
            var currentOutput = elements.outputText.value;
            if (!currentOutput) {
                showStatus('Generate chapters first, then use quick actions to refine them.', 'error');
                return;
            }

            // Disable quick action buttons during processing
            var quickBtns = document.querySelectorAll('.quick-action-btn');
            quickBtns.forEach(function(btn) { btn.disabled = true; });

            elements.loading.classList.add('visible');
            elements.loadingText.textContent = 'Refining chapters...';

            try {
                var ltgvKey = localStorage.getItem('ltgv_api_key');
                var headers = { 'Content-Type': 'application/json' };
                if (ltgvKey) {
                    headers['x-api-key'] = ltgvKey;
                } else {
                    headers['x-free-trial'] = 'true';
                }

                var response = await fetch('/api/tools/chaptergen', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        transcript: elements.transcriptArea.value,
                        action: action,
                        currentChapters: currentOutput
                    })
                });

                var data = await response.json();

                if (!response.ok) {
                    if (data.error && (data.error.includes('Invalid') || data.error.includes('revoked') || data.error.includes('expired'))) {
                        throw new Error('Your access has expired. <a href="/dashboard.html">Get a new access link</a>');
                    }
                    throw new Error('Something went wrong. Please try again.');
                }

                // Update output
                elements.outputText.value = data.result;
                animateOutput();
                generatedChapters = data.result;
                updateOutputCounter();
                showStatus('Chapters refined!', 'success');

            } catch (error) {
                showStatus(error.message || 'Something went wrong. Please try again.', 'error');
            } finally {
                elements.loading.classList.remove('visible');
                quickBtns.forEach(function(btn) { btn.disabled = false; });
            }
        }

        // ============ FEEDBACK FORM ============
        (function() {
            var feedbackForm = document.getElementById('feedbackForm');
            var feedbackText = document.getElementById('feedbackText');
            var feedbackSubmit = document.getElementById('feedbackSubmit');
            var feedbackSuccess = document.getElementById('feedbackSuccess');
            var feedbackError = document.getElementById('feedbackError');

            if (feedbackForm) {
                feedbackForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    var message = feedbackText.value.trim();
                    if (!message) return;

                    feedbackSubmit.disabled = true;
                    feedbackSubmit.textContent = 'Sending...';
                    feedbackSuccess.classList.remove('visible');
                    feedbackError.classList.remove('visible');

                    fetch('https://formspree.io/f/xdkogjkq', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            tool: 'ChapterGen',
                            message: message
                        })
                    })
                    .then(function(response) {
                        if (response.ok) {
                            feedbackSuccess.classList.add('visible');
                            feedbackText.value = '';
                            feedbackForm.style.display = 'none';
                        } else {
                            throw new Error('Failed');
                        }
                    })
                    .catch(function() {
                        feedbackError.classList.add('visible');
                    })
                    .finally(function() {
                        feedbackSubmit.disabled = false;
                        feedbackSubmit.textContent = 'Submit Feedback';
                    });
                });
            }
        })();

        // ============ TOOLTIP GUIDE ============
        (function() {
            var STORAGE_KEY = 'chaptergen_tour_complete';

            // Skip if tour already completed
            if (localStorage.getItem(STORAGE_KEY)) return;

            var tooltips = [
                {
                    target: '#transcriptArea',
                    text: 'Paste your YouTube transcript here',
                    arrow: 'top'
                },
                {
                    target: '#generateBtn',
                    text: 'Hit generate to create chapters',
                    arrow: 'top'
                },
                {
                    target: '#outputText',
                    text: 'Your chapters appear here, ready to copy!',
                    arrow: 'top'
                }
            ];

            var currentStep = 0;
            var overlay, tooltipBox;

            function createTooltipElements() {
                overlay = document.createElement('div');
                overlay.className = 'tooltip-overlay';
                document.body.appendChild(overlay);

                tooltipBox = document.createElement('div');
                tooltipBox.className = 'tooltip-box';
                tooltipBox.innerHTML = '<div class="tooltip-step"></div><div class="tooltip-text"></div><div class="tooltip-actions"><button class="tooltip-btn tooltip-btn-secondary" id="skipTour">Skip tour</button><button class="tooltip-btn tooltip-btn-primary" id="nextTip">Got it</button></div>';
                document.body.appendChild(tooltipBox);

                document.getElementById('skipTour').addEventListener('click', endTour);
                document.getElementById('nextTip').addEventListener('click', nextStep);
            }

            function showStep(index) {
                if (index >= tooltips.length) {
                    endTour();
                    return;
                }

                var tip = tooltips[index];
                var target = document.querySelector(tip.target);
                if (!target) {
                    nextStep();
                    return;
                }

                var prev = document.querySelector('.tooltip-highlight');
                if (prev) prev.classList.remove('tooltip-highlight');

                target.classList.add('tooltip-highlight');
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });

                setTimeout(function() {
                    var rect = target.getBoundingClientRect();
                    tooltipBox.className = 'tooltip-box visible arrow-' + tip.arrow;

                    if (tip.arrow === 'top') {
                        tooltipBox.style.top = (rect.bottom + 16) + 'px';
                        tooltipBox.style.left = Math.max(20, rect.left) + 'px';
                    } else if (tip.arrow === 'bottom') {
                        tooltipBox.style.top = (rect.top - tooltipBox.offsetHeight - 16) + 'px';
                        tooltipBox.style.left = Math.max(20, rect.left) + 'px';
                    }

                    tooltipBox.querySelector('.tooltip-step').textContent = 'Step ' + (index + 1) + ' of ' + tooltips.length;
                    tooltipBox.querySelector('.tooltip-text').textContent = tip.text;

                    var nextBtn = document.getElementById('nextTip');
                    nextBtn.textContent = index === tooltips.length - 1 ? 'Start creating!' : 'Got it';
                }, 300);

                overlay.classList.add('visible');
            }

            function nextStep() {
                currentStep++;
                showStep(currentStep);
            }

            function endTour() {
                localStorage.setItem(STORAGE_KEY, 'true');
                overlay.classList.remove('visible');
                tooltipBox.classList.remove('visible');
                var highlighted = document.querySelector('.tooltip-highlight');
                if (highlighted) highlighted.classList.remove('tooltip-highlight');
            }

            setTimeout(function() {
                createTooltipElements();
                showStep(0);
            }, 800);
        })();

    </script>
</body>
</html>
